"use strict";const audioContext=new(window.AudioContext||window.webkitAudioContext),Utils={svgElements:["rect","circle","ellipse","line","polyline","polygon","path","text","tspan","textPath","svg","g","defs","use","symbol","style","clipPath","mask","filter","pattern","linearGradient","radialGradient","title","desc","image"],Elem:{$:t=>document.querySelector(t),$$:t=>document.querySelectorAll(t),cE(t,e={}){const a=Utils.svgElements.includes(t)?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t);for(const[t,s]of Object.entries(e))null!=s&&a.setAttribute(t,s);return a},addClass:(t,...e)=>(t instanceof Element?t:Utils.Elem.$(t))?.classList.add(...e),remClass:(t,...e)=>(t instanceof Element?t:Utils.Elem.$(t))?.classList.remove(...e),attr(t,e,a){const s=t instanceof Element?t:this.$(t);if(s)return void 0===a?s.getAttribute(e):void s.setAttribute(e,a)},on:(t,e,a,s)=>{const o=t instanceof Element||t instanceof Document||t===window?t:Utils.Elem.$(t);o?.addEventListener(e,a,s)}},AudioWave:(t,e,a)=>{if(!t)return;const s=[],o=e.getContext("2d"),n=t.getChannelData(0),i=t.length/t.sampleRate,l=e.height/2*.5,r=e.height/2-l,c=Math.ceil(n.length/e.width);o.clearRect(0,0,e.width,e.height),o.fillStyle=a;for(let t=0;t<e.width;t++){let a=1,d=-1;for(let e=0;e<c;e++){const s=t*c+e;if(s>=n.length)break;const o=n[s];o<a&&(a=o),o>d&&(d=o)}const f=(1+a)*l+r,u=Math.max(1,(d-a)*l);s.push(t/e.width*i),o.fillRect(t,f,1,u)}return s.push(i),s},Attach:(t,e)=>{for(let a in e)t.appendChild(e[a])},GetElapsed:(t,e)=>{if(!e)return 0;const a=audioContext.currentTime,s=a-t.timing.current;return t.timing.current=a,t.timing.elapsed+=s*e.playbackRate.value,t.timing.elapsed},FormatTime:t=>{const e=Math.floor(t);return Math.floor(e%3600/60).toString().padStart(2,"0")+":"+(e%60).toString().padStart(2,"0")},isSupported:t=>{if(!t)return!1;const e={mp3:"audio/mpeg",wav:"audio/wav",ogg:'audio/ogg; codecs="vorbis"',aac:'audio/mp4; codecs="mp4a.40.2"'}[t.split(".").pop().toLowerCase()];if(!e)return!1;const a=document.createElement("audio").canPlayType(e);return"probably"===a||"maybe"===a},SleepMS:t=>new Promise(e=>setTimeout(e,t))};let modelSession;const state={buffer:{vocal:null,music:null},source:{vocal:null,music:null},pixmap:{vocal:null,music:null},volume:{node:{vocal:null,music:null},gain:{vocal:1,music:0}},detail:null,timing:{current:0,elapsed:0},paused:0,played:0,onplay:!1,duration:0},UI={fileBtn:Utils.Elem.$("#fileBtn"),saveBtn:Utils.Elem.$("#saveBtn"),playBtn:Utils.Elem.$("#playBtn"),progress:Utils.Elem.$(".progress"),tracks:Utils.Elem.$(".tracks"),graph:Utils.Elem.$(".graph")},getFileName=(t,e="",a="")=>{const s=t.lastIndexOf(".");return s<=0?e+t+a:e+t.slice(0,s)+a},toBase64=(t,e)=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.readAsDataURL(t)},Status={el:Utils.Elem.$("#status-window"),pct:Utils.Elem.$("#floating-percent"),msg:Utils.Elem.$("#floating-infoMsg"),show(t){this.msg.innerText=t,this.msg.style.color="#fff",this.pct.classList.remove("hidden"),this.el.classList.remove("-translate-y-24","opacity-0")},update(t){this.pct.dataset.text=t+"%"},error(t){this.msg.innerText=t,this.pct.classList.add("hidden"),this.el.classList.remove("-translate-y-24","opacity-0"),setTimeout(()=>this.hide(),5e3)},hide(){this.el.classList.add("-translate-y-24","opacity-0")}},updateUIProgress=t=>Utils.Elem.attr("#progress-percent","data-text",Math.round(t)+"%"),playBuffer=()=>{if(!state.buffer.vocal&&!state.buffer.music)return;state.timing.elapsed=state.paused,state.timing.current=audioContext.currentTime,state.played=audioContext.currentTime-state.paused,state.source.vocal=audioContext.createBufferSource(),state.source.vocal.buffer=state.buffer.vocal,state.source.music=audioContext.createBufferSource(),state.source.music.buffer=state.buffer.music,state.volume.node.vocal=audioContext.createGain(),state.volume.node.vocal.gain.value=state.volume.gain.vocal,state.volume.node.music=audioContext.createGain(),state.volume.node.music.gain.value=state.volume.gain.music,state.source.vocal.connect(state.volume.node.vocal).connect(audioContext.destination),state.source.music.connect(state.volume.node.music).connect(audioContext.destination),state.source.vocal.onended=()=>{setTimeout(()=>{state.timing.elapsed>=state.duration&&UI.graph.style.setProperty("--left","0px")},25)},state.source.vocal.start(0,state.paused),state.source.music.start(0,state.paused);const updateLoop=()=>{if(state.source.vocal&&state.onplay){const t=Utils.GetElapsed(state,state.source.vocal),e=Utils.FormatTime(t),getPos=t=>{const e=UI.graph.offsetWidth,a=t/state.buffer.vocal.duration;return Math.min(a*e,e).toFixed(1)+"px"};t>=state.duration&&(state.source.vocal?.stop(),state.source.music?.stop(),state.source.vocal=state.source.music=null,state.paused=0,state.onplay=!1,Utils.Elem.addClass("#stopBuffer","hidden"),Utils.Elem.remClass("#playBuffer","hidden"),UI.graph.dataset.text=Utils.FormatTime(state.duration)),UI.graph.dataset.text=e,UI.graph.style.setProperty("--left",getPos(t)),requestAnimationFrame(updateLoop)}};state.onplay=!0,Utils.Elem.addClass("#playBuffer","hidden"),Utils.Elem.remClass("#stopBuffer","hidden"),updateLoop()},GetBuffer=async(t,e)=>{const a=audioContext.createBuffer(2,t.length,44100);a.copyToChannel(t,0),a.copyToChannel(e,1);const s=new OfflineAudioContext(2,t.length,44100),o=s.createBufferSource();o.buffer=a;const n=s.createDynamicsCompressor();n.threshold.setValueAtTime(-18,0),n.knee.setValueAtTime(12,0),n.ratio.setValueAtTime(4,0),n.attack.setValueAtTime(.005,0),n.release.setValueAtTime(.2,0);const i=s.createGain();return i.gain.setValueAtTime(1.4,0),o.connect(n),n.connect(i),i.connect(s.destination),o.start(),await s.startRendering()},mp3encode=async(t,e)=>{const a=t.sampleRate,s=new lamejs.Mp3Encoder(2,a,128),o=[],n=t.getChannelData(0),i=t.numberOfChannels>1?t.getChannelData(1):n,l=n.length,r=1152;for(let t=0;t<l;t+=r){const a=n.subarray(t,t+r),c=i.subarray(t,t+r),d=new Int16Array(a.length),f=new Int16Array(c.length);for(let t=0;t<a.length;t++)d[t]=a[t]<0?32768*a[t]:32767*a[t],f[t]=c[t]<0?32768*c[t]:32767*c[t];const u=s.encodeBuffer(d,f);u.length>0&&o.push(u),e&&e(Math.round(t/l*100)),t%11520==0&&await new Promise(t=>setTimeout(t,0))}const c=s.flush();return c.length>0&&o.push(c),e&&e(100),new Blob(o,{type:"audio/mp3"})};Utils.Elem.on(document,"input",async t=>{const e=t.target,a=parseFloat(e.value),s=e.id;"vocal"!==s&&"music"!==s||(state.volume.gain[s]=a,state.volume.node[s]?.gain.setTargetAtTime(a,audioContext.currentTime,.01),e.parentElement.dataset.value=(100*a).toFixed())}),Utils.Elem.on(window,"click",()=>{const t=Utils.Elem.$("#download-menu");t.classList.contains("hidden")||Utils.Elem.addClass(t,"hidden")}),Utils.Elem.on(document,"click",async t=>{if(t.target.hasAttribute("data-button")){t.preventDefault(),t.stopPropagation();const e=t.target.dataset.button;if("uploadBtn"===e){const e=Utils.Elem.cE("input",{type:"file"}),a=104857600,s=1200;Utils.Elem.on(e,"input",async e=>{const o=e.target.files[0];if(audioContext&&o){if(o.size>a)return Status.error("File too large. Maximum size: 100MB.");if(!Utils.isSupported(o.name))return Status.error("Not supported file format!");updateUIProgress(0),Utils.Elem.addClass(t.target,"disabled"),Utils.Elem.remClass(UI.progress,"hidden"),state.detail=o.name;let e=await audioContext.decodeAudioData(await o.arrayBuffer());if(44100!==e.sampleRate){const t=new OfflineAudioContext(e.numberOfChannels,Math.ceil(44100*e.duration),44100),a=t.createBufferSource();a.buffer=e,a.connect(t.destination),a.start(0),e=await t.startRendering()}if(state.paused=0,state.duration=e.duration,UI.graph.style.setProperty("--left","0px"),UI.graph.dataset.text=Utils.FormatTime(state.duration),state.duration>s)return void Status.error("Audio too long. Maximum length: 20 minutes.");const n=new Worker(URL.createObjectURL(new Blob(['self.onmessage=function(a){function b(a,b,c,d,g){const h=new Float32Array(a.originalLength+e.fftSize),i=new Float32Array(a.originalLength+e.fftSize),l=.95;for(let n=0;n<a.mags.length;n++){const o=Math.floor(n/512),p=n%512,q=new Float32Array(2*e.fftSize);for(let e=0;1024>e;e++){const f=b[1024*(512*(c*d))+1024*(512*o)+1024*p+e],h=a.mags[n][e],i=Math.pow(f,l),j=Math.pow(Math.max(0,h-f),l),k=h*(g?j/(i+j+1e-10):i/(i+j+1e-10));q[2*e]=k*Math.cos(a.phases[n][e]),q[2*e+1]=k*Math.sin(a.phases[n][e])}j.process(q,!0);const r=n*e.hopSize;for(let a=0;a<e.fftSize;a++)h[r+a]+=q[2*a]*k[a],i[r+a]+=k[a]*k[a]}for(let e=0;e<h.length;e++)1e-5<i[e]&&(h[e]/=i[e]);return h}const{mode:c,data:d,config:e,mask:f,numSplits:g,specL:h,specR:i}=a.data,j=new function(a){this.n=a,this.rev=new Int32Array(a);for(let b,c=0;c<a;c++){b=0;for(let d=0;d<Math.log2(a);d++)1&c>>d&&(b|=1<<Math.log2(a)-1-d);this.rev[c]=b}this.process=function(a,b){for(let c,d=0;d<this.n;d++)c=this.rev[d],d<c&&([a[2*d],a[2*c]]=[a[2*c],a[2*d]],[a[2*d+1],a[2*c+1]]=[a[2*c+1],a[2*d+1]]);for(let c=1;c<this.n;c<<=1){let d=Math.cos(Math.PI/c),e=(b?1:-1)*Math.sin(Math.PI/c);for(let b=0;b<this.n;b+=2*c){let f=1,g=0;for(let h=0;h<c;h++){let i=2*(b+h),j=2*(b+h+c),k=f*a[j]-g*a[j+1],l=f*a[j+1]+g*a[j];a[j]=a[i]-k,a[j+1]=a[i+1]-l,a[i]+=k,a[i+1]+=l;let m=f*d-g*e;g=f*e+g*d,f=m}}}if(b)for(let b=0;b<2*this.n;b++)a[b]/=this.n}}(e.fftSize),k=new Float32Array(e.fftSize);for(let b=0;b<e.fftSize;b++)k[b]=Math.sqrt(.5*(1-Math.cos(2*Math.PI*b/(e.fftSize-1))));if("stft"===c){const b=function(a){const b=[],c=[];for(let d=0;d+e.fftSize<=a.length;d+=e.hopSize){const f=new Float32Array(2*e.fftSize);for(let b=0;b<e.fftSize;b++)f[2*b]=a[d+b]*k[b];j.process(f,!1);const g=new Float32Array(1024),h=new Float32Array(1024);for(let a=0;1024>a;a++)g[a]=Math.sqrt(f[2*a]**2+f[2*a+1]**2),h[a]=Math.atan2(f[2*a+1],f[2*a]);b.push(g),c.push(h)}return{mags:b,phases:c,originalLength:a.length}}(d);self.postMessage({mode:"stft_done",result:b,channel:a.data.channel})}else"reconstruct"===c&&self.postMessage({mode:"rec_done",vL:b(h,f,0,g,!1),vR:b(i,f,1,g,!1),iL:b(h,f,0,g,!0),iR:b(i,f,1,g,!0)})};'],{type:"text/javascript"})));Utils.Elem.addClass(UI.tracks,"hidden");const i=await((t,e)=>new Promise((a,s)=>{let o=null,n=null;const i={fftSize:4096,hopSize:1024};Utils.Elem.addClass(UI.fileBtn,"disabled"),updateUIProgress(15),e.postMessage({mode:"stft",data:t.getChannelData(0),channel:"L",config:i}),e.postMessage({mode:"stft",data:t.numberOfChannels>1?t.getChannelData(1):t.getChannelData(0),channel:"R",config:i}),e.onmessage=async t=>{try{if("stft_done"===t.data.mode){if("L"===t.data.channel?o=t.data.result:n=t.data.result,o&&n){const t=o.mags.length,a=Math.ceil(t/512),s=new Float32Array(2*a*512*1024);for(let e=0;e<a;e++){const i=new Float32Array(1048576);for(let a=0;a<512;a++){const s=512*e+a;if(s<t)for(let t=0;t<1024;t++)i[1024*a+t]=o.mags[s][t],i[524288+1024*a+t]=n.mags[s][t]}const l=(await modelSession.run({x:new ort.Tensor("float32",i,[2,1,512,1024])})).y.data;for(let t=0;t<2;t++){const o=t*a*512*1024+512*e*1024,n=512*t*1024;for(let t=0;t<524288;t++)s[o+t]=l[n+t]}updateUIProgress(20+.6*Math.round((e+1)/a*100)),await new Promise(t=>requestAnimationFrame(t))}updateUIProgress(85),e.postMessage({mode:"reconstruct",mask:s,numSplits:a,specL:o,specR:n,config:i})}}else if("rec_done"===t.data.mode){updateUIProgress(95);const e=await GetBuffer(t.data.vL,t.data.vR);updateUIProgress(97);const s=await GetBuffer(t.data.iL,t.data.iR);updateUIProgress(100),Utils.Elem.remClass(UI.fileBtn,"disabled"),a({vocal:e,music:s})}}catch(t){s(t)}}}))(e,n);state.buffer.vocal=i.vocal,state.buffer.music=i.music,Utils.Elem.remClass(t.target,"disabled"),Utils.Elem.addClass(UI.progress,"hidden"),state.pixmap.vocal=Utils.AudioWave(i.vocal,Utils.Elem.$("#canvas-vocal"),"#fbbf24"),state.pixmap.music=Utils.AudioWave(i.music,Utils.Elem.$("#canvas-music"),"#38bdf8"),Utils.Elem.remClass(UI.tracks,"hidden")}}),e.click()}else if("playBtn"===e)"suspended"===audioContext.state&&await audioContext.resume(),state.onplay?(state.source.vocal?.stop(),state.source.music?.stop(),state.source.vocal=state.source.music=null,state.onplay=!1,state.paused=audioContext.currentTime-state.played,Utils.Elem.addClass("#stopBuffer","hidden"),Utils.Elem.remClass("#playBuffer","hidden")):playBuffer();else if("saveBtn"===e)Utils.Elem.remClass("#download-menu","hidden");else if("saveVocal"===e){Utils.Elem.addClass("#download-menu","hidden"),Status.show("Export vocal to file...");const t=await mp3encode(state.buffer.vocal,t=>Status.update(t));toBase64(t,t=>{const e=Utils.Elem.cE("a",{download:getFileName(state.detail,"vocal_",".mp3"),href:t});document.body.appendChild(e),e.click(),document.body.removeChild(e)}),Status.hide()}else if("saveMusic"===e){Utils.Elem.addClass("#download-menu","hidden"),Status.update(0),Status.show("Export music to file...");const t=await mp3encode(state.buffer.music,t=>Status.update(t));toBase64(t,t=>{const e=Utils.Elem.cE("a",{download:getFileName(state.detail,"music_",".mp3"),href:t});document.body.appendChild(e),e.click(),document.body.removeChild(e)}),Status.hide()}}else if(t.target===UI.graph){const e=t.target.getBoundingClientRect(),a=t.clientX-e.left|0,s=Number(state.pixmap.vocal[a]);state.onplay?(state.source.vocal?.stop(),state.source.music?.stop(),state.source.vocal=state.source.music=null,state.onplay=!1,state.paused=s,await Utils.SleepMS(25),playBuffer()):state.paused=s,UI.graph.dataset.text=Utils.FormatTime(s),UI.graph.style.setProperty("--left",a+"px")}}),(async()=>{ort.env.logLevel="error";const t="data/model.onnx";try{const e=await caches.open("ort-model-cache"),a=await e.match(t);let s;if(a)s=await a.arrayBuffer();else{const a=await fetch(t);if(!a.ok)throw new Error("Model file not found!");await e.put(t,a.clone()),s=await a.arrayBuffer()}modelSession=await ort.InferenceSession.create(s,{executionProviders:["wasm"],executionMode:"parallel",graphOptimizationLevel:"all",numThreads:navigator.hardwareConcurrency||4}),Utils.Elem.remClass(UI.fileBtn,"disabled")}catch(t){console.error(t),Status.error("Error: Model loading failed!")}})();const resizeObserver=new ResizeObserver(t=>{for(let e of t){const{width:t,height:a}=e.contentRect,s=Utils.Elem.$("#canvas-vocal"),o=Utils.Elem.$("#canvas-music");if(s.width=t,o.width=t,state.buffer.vocal&&(state.pixmap.vocal=Utils.AudioWave(state.buffer.vocal,s,"#fbbf24"),state.pixmap.music=Utils.AudioWave(state.buffer.music,o,"#38bdf8"),!state.onplay)){const e=state.paused/state.buffer.vocal.duration;UI.graph.style.setProperty("--left",Math.min(e*t,t).toFixed(1)+"px")}}});resizeObserver.observe(UI.graph);