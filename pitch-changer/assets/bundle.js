"use strict";const audioContext=new(window.AudioContext||window.webkitAudioContext),Utils={svgElements:["rect","circle","ellipse","line","polyline","polygon","path","text","tspan","textPath","svg","g","defs","use","symbol","style","clipPath","mask","filter","pattern","linearGradient","radialGradient","title","desc","image"],Elem:{$:t=>document.querySelector(t),$$:t=>document.querySelectorAll(t),cE(t,e={}){const s=Utils.svgElements.includes(t)?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t);for(const[t,a]of Object.entries(e))null!=a&&s.setAttribute(t,a);return s},addClass:(t,...e)=>(t instanceof Element?t:Utils.Elem.$(t))?.classList.add(...e),remClass:(t,...e)=>(t instanceof Element?t:Utils.Elem.$(t))?.classList.remove(...e),attr(t,e,s){const a=t instanceof Element?t:this.$(t);if(a)return void 0===s?a.getAttribute(e):void a.setAttribute(e,s)},text(t,e){const s=t instanceof Element?t:this.$(t);if(s)return void 0===e?s.textContent:void(s.textContent=e)},on:(t,e,s,a)=>{const i=t instanceof Element||t instanceof Document||t===window?t:Utils.Elem.$(t);i?.addEventListener(e,s,a)}},AudioWave:(t,e,s)=>{if(!t)return;const a=[],i=e.getContext("2d"),n=t.getChannelData(0),o=t.length/t.sampleRate,l=e.height/2*.5,r=e.height/2-l,u=Math.ceil(n.length/e.width);i.clearRect(0,0,e.width,e.height),i.fillStyle=s;for(let t=0;t<e.width;t++){let s=1,d=-1;for(let e=0;e<u;e++){const a=t*u+e;if(a>=n.length)break;const i=n[a];i<s&&(s=i),i>d&&(d=i)}const f=(1+s)*l+r,c=Math.max(1,(d-s)*l);a.push(t/e.width*o),i.fillRect(t,f,1,c)}return a.push(o),a},Attach:(t,e)=>{for(let s in e)t.appendChild(e[s])},GetElapsed:(t,e)=>{if(!e)return 0;const s=audioContext.currentTime,a=s-t.timing.current;return t.timing.current=s,t.timing.elapsed+=a*e.playbackRate.value,t.timing.elapsed},FormatTime:t=>{const e=Math.floor(t);return Math.floor(e%3600/60).toString().padStart(2,"0")+":"+(e%60).toString().padStart(2,"0")},isSupported:t=>{if(!t)return!1;const e={mp3:"audio/mpeg",wav:"audio/wav",ogg:'audio/ogg; codecs="vorbis"',aac:'audio/mp4; codecs="mp4a.40.2"'}[t.split(".").pop().toLowerCase()];if(!e)return!1;const s=document.createElement("audio").canPlayType(e);return"probably"===s||"maybe"===s},SleepMS:t=>new Promise(e=>setTimeout(e,t))},state={buffer:null,source:null,pixmap:null,stretch:{node:null,semitones:.01,formantSemitones:.01,formantCompensation:!1},timing:{current:0,elapsed:0},detail:null,onplay:!1,paused:0,played:0,length:0},UI={fileBtn:Utils.Elem.$("#fileBtn"),saveBtn:Utils.Elem.$("#saveBtn"),playBtn:Utils.Elem.$("#playBtn"),progress:Utils.Elem.$(".progress"),tracks:Utils.Elem.$(".tracks"),graph:Utils.Elem.$(".graph")},getFileName=(t,e="",s="")=>{const a=t.lastIndexOf(".");return a<=0?e+t+s:e+t.slice(0,a)+s},toBase64=(t,e)=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.readAsDataURL(t)},Status={el:Utils.Elem.$("#status-window"),pct:Utils.Elem.$("#floating-percent"),msg:Utils.Elem.$("#floating-infoMsg"),show(t){this.msg.innerText=t,this.msg.style.color="#fff",this.pct.classList.remove("hidden"),this.el.classList.remove("-translate-y-24","opacity-0")},update(t){this.pct.dataset.text=t+"%"},error(t){this.msg.innerText=t,this.pct.classList.add("hidden"),this.el.classList.remove("-translate-y-24","opacity-0"),setTimeout(()=>this.hide(),5e3)},hide(){this.el.classList.add("-translate-y-24","opacity-0")}},Render=async()=>{if(!state.buffer)return null;Status.show("Render audio buffer...");const t=new OfflineAudioContext(state.buffer.numberOfChannels,state.buffer.length,state.buffer.sampleRate),e=await Stretch(t);e.connect(t.destination),e.start(0),await e.setUpdateInterval(.05,t=>{Status.update((100*Math.min(1,t/state.buffer.duration)).toFixed())}),e.schedule({semitones:state.stretch.semitones,formantSemitones:state.stretch.formantSemitones,formantCompensation:state.stretch.formantCompensation});let s=[];for(let t=0;t<state.buffer.numberOfChannels;++t)s.push(state.buffer.getChannelData(t));e.addBuffers(s);return await t.startRendering()},updateUIProgress=t=>{Utils.Elem.attr("#progress-percent","data-text",Math.round(t)+"%")},playBuffer=async()=>{if(!state.buffer)return;state.timing.elapsed=state.paused,state.timing.current=audioContext.currentTime,state.played=audioContext.currentTime-state.paused,state.source=audioContext.createBufferSource(),state.source.buffer=state.buffer,state.stretch.node=await Stretch(audioContext),state.stretch.node.connect(audioContext.destination),state.stretch.node.start(),state.stretch.node.schedule({semitones:state.stretch.semitones,formantSemitones:state.stretch.formantSemitones,formantCompensation:state.stretch.formantCompensation}),state.source.connect(state.stretch.node).connect(audioContext.destination),state.source.onended=()=>{state.stretch.node?.stop(),state.stretch.node=null,setTimeout(()=>{state.timing.elapsed>=state.length&&UI.graph.style.setProperty("--left","0px")},25)},state.source.start(0,state.paused);const updateLoop=()=>{if(state.source&&state.onplay){const t=Utils.GetElapsed(state,state.source),e=Utils.FormatTime(t),getPos=t=>{const e=UI.graph.offsetWidth,s=t/state.buffer.duration;return Math.min(s*e,e).toFixed(1)+"px"};t>=state.length&&(state.source?.stop(),state.stretch.node?.stop(),state.source=null,state.paused=0,state.onplay=!1,state.stretch.node=null,Utils.Elem.addClass("#stopBuffer","hidden"),Utils.Elem.remClass("#playBuffer","hidden"),UI.graph.dataset.text=Utils.FormatTime(state.length)),UI.graph.dataset.text=e,UI.graph.style.setProperty("--left",getPos(t)),requestAnimationFrame(updateLoop)}};state.onplay=!0,Utils.Elem.addClass("#playBuffer","hidden"),Utils.Elem.remClass("#stopBuffer","hidden"),updateLoop()},mp3encode=async(t,e)=>{const s=t.sampleRate,a=new lamejs.Mp3Encoder(2,s,128),i=[],n=t.getChannelData(0),o=t.numberOfChannels>1?t.getChannelData(1):n,l=n.length,r=1152;for(let t=0;t<l;t+=r){const s=n.subarray(t,t+r),u=o.subarray(t,t+r),d=new Int16Array(s.length),f=new Int16Array(u.length);for(let t=0;t<s.length;t++)d[t]=s[t]<0?32768*s[t]:32767*s[t],f[t]=u[t]<0?32768*u[t]:32767*u[t];const c=a.encodeBuffer(d,f);c.length>0&&i.push(c),e&&e(Math.round(t/l*100)),t%11520==0&&await new Promise(t=>setTimeout(t,0))}const u=a.flush();return u.length>0&&i.push(u),e&&e(100),new Blob(i,{type:"audio/mp3"})};Utils.Elem.on(document,"input",async t=>{const e=t.target,s=parseFloat(e.value),a=e.id;"transpose-slider"===a&&(state.stretch.semitones=0===Number(s)?.01:Number(s),state.stretch.node?.schedule({semitones:state.stretch.semitones}),Utils.Elem.text("#transpose-value",s)),"formant-slider"===a&&(state.stretch.formantSemitones=0===Number(s)?.01:Number(s),state.stretch.node?.schedule({formantSemitones:state.stretch.formantSemitones}),Utils.Elem.text("#formant-value",s)),"formant-compensation"===a&&(state.stretch.formantCompensation=e.checked,state.stretch.node?.schedule({formantCompensation:state.stretch.formantCompensation}))}),Utils.Elem.on(document,"click",async t=>{if(t.target.hasAttribute("data-button")){t.preventDefault(),t.stopPropagation();const e=t.target.dataset.button;if("fileBtn"===e){const e=Utils.Elem.cE("input",{type:"file"}),s=104857600,a=3599;Utils.Elem.on(e,"input",async e=>{const i=e.target.files[0];if(audioContext&&i){if(i.size>s)return Status.error("File too large. Maximum size: 100MB.");if(!Utils.isSupported(i.name))return Status.error("Not supported file format!");updateUIProgress(0),Utils.Elem.addClass(UI.tracks,"hidden"),Utils.Elem.addClass(t.target,"disabled"),Utils.Elem.remClass(UI.progress,"hidden"),state.detail=i.name;let e=await audioContext.decodeAudioData(await i.arrayBuffer());if(state.paused=0,state.length=e.duration,UI.graph.style.setProperty("--left","0px"),UI.graph.dataset.text=Utils.FormatTime(state.length),state.length>a)return void Status.error("Audio too long. Maximum length: 20 minutes.");state.buffer=e,Utils.Elem.text("#detail",state.detail),Utils.Elem.remClass(t.target,"disabled"),Utils.Elem.addClass(UI.progress,"hidden"),state.pixmap=Utils.AudioWave(e,Utils.Elem.$("#canvas"),"#fbbf24"),Utils.Elem.remClass(UI.tracks,"hidden")}}),e.click()}else if("playBtn"===e)"suspended"===audioContext.state&&await audioContext.resume(),state.onplay?(state.source?.stop(),state.source=null,state.onplay=!1,state.paused=audioContext.currentTime-state.played,Utils.Elem.addClass("#stopBuffer","hidden"),Utils.Elem.remClass("#playBuffer","hidden")):await playBuffer();else if("saveBtn"===e){const t=await Render(state.buffer);if(await Utils.SleepMS(25),t){Status.update(0),Status.show("Export audio to file...");const e=await mp3encode(t,t=>Status.update(t));toBase64(e,t=>{const e=Utils.Elem.cE("a",{download:getFileName(state.detail,"modified_",".mp3"),href:t});document.body.appendChild(e),e.click(),document.body.removeChild(e)})}Status.hide()}}else if(t.target===UI.graph){const e=t.target.getBoundingClientRect(),s=t.clientX-e.left|0,a=Number(state.pixmap[s]);state.onplay?(state.source?.stop(),state.source=null,state.onplay=!1,state.paused=a,await Utils.SleepMS(25),await playBuffer()):state.paused=a,UI.graph.dataset.text=Utils.FormatTime(a),UI.graph.style.setProperty("--left",s+"px")}});const resizeObserver=new ResizeObserver(t=>{for(let e of t){const{width:t,height:s}=e.contentRect,a=Utils.Elem.$("#canvas");if(a.width=t,state.buffer&&(state.pixmap=Utils.AudioWave(state.buffer,a,"#fbbf24"),!state.onplay)){const e=state.paused/state.buffer.duration;UI.graph.style.setProperty("--left",Math.min(e*t,t).toFixed(1)+"px")}}});resizeObserver.observe(UI.graph);